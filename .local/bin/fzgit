#!/bin/env sh
HEADER="[ENTER] Print selected [TAB] Toggle selection [ALT-F] View file [ALT-H] Commit log [ALT-L] Commit log (oneline)"
: "${progname:="${0##*/}"}"
: "${REPO:=./}"

usage() {
	cat <<_EOF
Usage: $progname [options]

Options:
 -r <repo-dir>		Set git repository to this directory
 -h			Show this page
_EOF
	exit 0
}

while getopts "r:h" opt; do
	case $opt in
		r) REPO="$OPTARG";;
		h) usage;;
	*) usage;;
	esac
done
shift $((OPTIND - 1))

REPO_TL=$(git -C "$REPO" rev-parse --show-toplevel) || { echo "${REPO} is not a git repo"; exit 1; }
git -C "$REPO_TL" ls-tree --full-tree -r --name-only HEAD \
	| sk --inline-info \
		--header="${HEADER}" \
		--prompt "File name > " \
		--layout=reverse-list \
		--preview="git -C \"${REPO_TL}\" show master:{1}" \
		--preview-window=up:40% \
		-m \
		--bind "alt-f:execute[ git -C \"${REPO_TL}\" show master:{} ]" \
		--bind "alt-l:execute[ git -C \"${REPO_TL}\" log --oneline -- {} ]" \
		--bind "alt-h:execute[ git -C \"${REPO_TL}\" log -p -- {} ]" \
		${1:+--query "$@"}

